document:
  dsl: '1.0.2'
  namespace: examples
  name: calculator-grpc-api
  version: '1.0.0'
  description: |
    Calculator gRPC API service using Python handlers.

    Listens on three gRPC methods:
    - grpc://localhost:50051/calculator.Calculator/Add - Add two numbers
    - grpc://localhost:50051/calculator.Calculator/Multiply - Multiply two numbers
    - grpc://localhost:50051/calculator.Calculator/GetPet - Fetch pet from petstore API

    Each request is validated against the protobuf schema and routed
    to the appropriate Python handler function.

do:
  # Listen for Add requests on calculator.Calculator/Add method
  - handleAddRequests:
      listen:
        to:
          any:
            - with:
                source:
                  uri: grpc://0.0.0.0:50051/calculator.Calculator/Add
                  schema:
                    format: grpc
                    resource:
                      endpoint: spec.proto
                      name: AddRequest
          until: '${ false }'  # Listen forever
      foreach:
        item: event
        do:
          - executeAdd:
              call: python
              with:
                module: calculator.add
                function: handler
                arguments:
                  - ${ $event }

  # Listen for Multiply requests on calculator.Calculator/Multiply method
  - handleMultiplyRequests:
      listen:
        to:
          any:
            - with:
                source:
                  uri: grpc://0.0.0.0:50051/calculator.Calculator/Multiply
                  schema:
                    format: grpc
                    resource:
                      endpoint: spec.proto
                      name: MultiplyRequest
          until: '${ false }'  # Listen forever
      foreach:
        item: event
        do:
          - executeMultiply:
              call: python
              with:
                module: calculator.multiply
                function: handler
                arguments:
                  - ${ $event }

  # Listen for GetPet requests on calculator.Calculator/GetPet method
  - handleGetPetRequests:
      listen:
        to:
          any:
            - with:
                source:
                  uri: grpc://0.0.0.0:50051/calculator.Calculator/GetPet
                  schema:
                    format: grpc
                    resource:
                      endpoint: spec.proto
                      name: GetPetRequest
          until: '${ false }'  # Listen forever
      foreach:
        item: event
        do:
          - executeGetPet:
              call: python
              with:
                module: calculator.get_pet
                function: handler
                arguments:
                  - ${ $event }
