document:
  dsl: '1.0.2'
  namespace: ci
  name: jackdaw-ci
  version: '1.0.0'
  description: 'CI pipeline for jackdaw - leveraging jackdaw itself for CI execution'

use:
  catalogs:
    local:
      endpoint:
        uri: file://./.ci/catalog

do:
  # Step 1: Compute file hashes for cache invalidation
  # Note: Uses $workflow.id to ensure this always runs (cache buster)
  - computeHashes:
      call: compute-hashes:1.0.0
      with:
        categories:
          rust_sources:
            patterns:
              - 'src/**/*.rs'
              - 'Cargo.toml'
              - 'Cargo.lock'
          sql_schemas:
            patterns:
              - 'sql/**/*.sql'
          ci_workflows:
            patterns:
              - '.ci/**/*.yaml'
              - '.ci/**/*.py'
          all_sources:
            patterns:
              - 'src/**/*.rs'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'sql/**/*.sql'
        workflow_id: ${ $workflow.id }
      output:
        as:
          computed_hash: ${ .stdout }

  - formatCheck:
      input:
        from: .computed_hash
      run:
        shell:
          command: cargo
          arguments:
            - fmt
            - --check

  # - clippyCheck:
  #     input:
  #       from: .computed_hash
  #     run:
  #       shell:
  #         command: cargo
  #         arguments:
  #           - clippy
  #           - --
  #           - -D
  #           - warning

  - runTests:
      input:
        from: .computed_hash
      run:
        shell:
          command: cargo
          arguments:
            - test
            - --workspace
            - --all-features
            - --verbose

  - buildRelease:
      input:
        from: .computed_hash
      run:
        shell:
          command: cargo
          arguments:
            - build
            - --release

  - buildReleaseLinuxAmd64:
      input:
        from: .computed_hash
      run:
        shell:
          command: bash
          arguments:
            - -c
            - |
              set -euo pipefail
              echo "Building Linux x86_64 binary in Docker..."
              docker buildx build --platform linux/amd64 --target builder --load -t jackdaw-builder:linux-amd64 .
              echo "Extracting binary..."
              mkdir -p dist
              docker create --name jackdaw-extract jackdaw-builder:linux-amd64
              docker cp jackdaw-extract:/build/target/release/jackdaw ./dist/jackdaw-linux-amd64
              docker rm jackdaw-extract
              echo "✓ Linux x86_64 binary ready: ./dist/jackdaw-linux-amd64"
              ls -lh ./dist/jackdaw-linux-amd64
              file ./dist/jackdaw-linux-amd64

  - buildReleaseLinuxArm64:
      input:
        from: .computed_hash
      run:
        shell:
          command: bash
          arguments:
            - -c
            - |
              set -euo pipefail
              echo "Building Linux aarch64 binary in Docker..."
              docker buildx build --platform linux/arm64 --target builder --load -t jackdaw-builder:linux-arm64 .
              echo "Extracting binary..."
              mkdir -p dist
              docker create --name jackdaw-extract jackdaw-builder:linux-arm64
              docker cp jackdaw-extract:/build/target/release/jackdaw ./dist/jackdaw-linux-arm64
              docker rm jackdaw-extract
              echo "✓ Linux aarch64 binary ready: ./dist/jackdaw-linux-arm64"
              ls -lh ./dist/jackdaw-linux-arm64
              file ./dist/jackdaw-linux-arm64

  - buildReleaseMacArm64:
      input:
        from: .computed_hash
      run:
        shell:
          command: bash
          arguments:
            - -c
            - |
              set -euo pipefail
              echo "Building macOS aarch64 binary in Docker..."
              docker buildx build --platform linux/arm64 --load -f Dockerfile.build-macos -t jackdaw-builder:macos-arm64 .
              echo "Extracting binary..."
              mkdir -p dist
              docker create --name jackdaw-extract jackdaw-builder:macos-arm64
              docker cp jackdaw-extract:/usr/local/bin/jackdaw ./dist/jackdaw-macos-arm64
              docker rm jackdaw-extract
              echo "✓ macOS aarch64 binary ready: ./dist/jackdaw-macos-arm64"
              ls -lh ./dist/jackdaw-macos-arm64
              file ./dist/jackdaw-macos-arm64