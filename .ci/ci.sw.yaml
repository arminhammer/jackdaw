document:
  dsl: '1.0.2'
  namespace: ci
  name: jackdaw-ci
  version: '1.0.0'
  description: 'CI pipeline for jackdaw - leveraging jackdaw itself for CI execution'

use:
  catalogs:
    local:
      endpoint:
        uri: file://./.ci/catalog

do:
  # Step 0: Log runtime and workflow info (test descriptors)
  - logRuntimeInfo:
      run:
        script:
          language: python
          arguments:
            - ${ $workflow.id }
          code: |
            import sys
            import json
            workflow_id = sys.argv[1]
            print(json.dumps({
                'workflow_id': workflow_id
            }))
      output:
        as: .workflow_id

  # Step 1: Compute file hashes for cache invalidation
  # Note: Uses $workflow.id to ensure this always runs (cache buster)
  - computeHashes:
      call: compute-hashes:1.0.0
      with:
        categories:
          rust_sources:
            patterns:
              - 'src/**/*.rs'
              - 'Cargo.toml'
              - 'Cargo.lock'
          sql_schemas:
            patterns:
              - 'sql/**/*.sql'
          ci_workflows:
            patterns:
              - '.ci/**/*.yaml'
              - '.ci/**/*.py'
          all_sources:
            patterns:
              - 'src/**/*.rs'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'sql/**/*.sql'
        workflow_id: ${ $workflow.id }
      output:
        as: 
          computed_hash: ${ .all_sources }